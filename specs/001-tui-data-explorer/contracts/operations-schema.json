{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://github.com/kittiwake/kittiwake/schemas/operations-v2.json",
  "title": "Kittiwake Operations Schema v2",
  "description": "Simplified schema for operations stored as narwhals code strings with metadata. Used in SavedAnalysis.operations field.",
  "version": "2.0.0",
  "type": "array",
  "items": {
    "$ref": "#/$defs/Operation"
  },
  "$defs": {
    "Operation": {
      "type": "object",
      "description": "Single data transformation operation with executable narwhals code and metadata",
      "properties": {
        "code": {
          "type": "string",
          "description": "Narwhals expression code string (e.g., 'df.filter(nw.col(\"age\") > 25)')",
          "minLength": 1
        },
        "display": {
          "type": "string",
          "description": "Human-readable operation description for UI display (e.g., 'Filter: age > 25')",
          "minLength": 1
        },
        "operation_type": {
          "type": "string",
          "enum": [
            "filter",
            "aggregate",
            "pivot",
            "join",
            "select",
            "drop",
            "rename",
            "with_columns",
            "sort",
            "unique",
            "fill_null",
            "drop_nulls",
            "head",
            "tail",
            "sample"
          ],
          "description": "Operation category for modal routing and icon display"
        },
        "params": {
          "type": "object",
          "description": "Operation parameters for modal editing (structure depends on operation_type)",
          "additionalProperties": true
        }
      },
      "required": ["code", "display", "operation_type", "params"],
      "examples": [
        {
          "code": "df.filter(nw.col('age') > 25)",
          "display": "Filter: age > 25",
          "operation_type": "filter",
          "params": {
            "column": "age",
            "operator": ">",
            "value": 25
          }
        },
        {
          "code": "df.group_by('region').agg([nw.col('sales').sum().alias('sales_sum')])",
          "display": "Aggregate: SUM of sales grouped by region",
          "operation_type": "aggregate",
          "params": {
            "column": "sales",
            "functions": ["sum"],
            "group_by": ["region"]
          }
        },
        {
          "code": "df.sort('date', descending=True)",
          "display": "Sort: date (descending)",
          "operation_type": "sort",
          "params": {
            "columns": ["date"],
            "descending": [true]
          }
        },
        {
          "code": "df.select(['name', 'email', 'age'])",
          "display": "Select: name, email, age",
          "operation_type": "select",
          "params": {
            "columns": ["name", "email", "age"]
          }
        },
        {
          "code": "df.drop_nulls()",
          "display": "Drop rows with null values",
          "operation_type": "drop_nulls",
          "params": {}
        }
      ]
    },
    "FilterParams": {
      "type": "object",
      "description": "Parameters for filter operations",
      "properties": {
        "column": {"type": "string"},
        "operator": {
          "type": "string",
          "enum": ["=", "!=", ">", "<", ">=", "<=", "contains", "startswith", "endswith", "isnull", "notnull"]
        },
        "value": {
          "oneOf": [
            {"type": "string"},
            {"type": "number"},
            {"type": "boolean"},
            {"type": "null"}
          ]
        }
      },
      "required": ["column", "operator"]
    },
    "AggregateParams": {
      "type": "object",
      "description": "Parameters for aggregation operations",
      "properties": {
        "column": {"type": "string"},
        "functions": {
          "type": "array",
          "items": {
            "type": "string",
            "enum": ["count", "sum", "mean", "median", "min", "max", "std", "var", "nunique"]
          },
          "minItems": 1
        },
        "group_by": {
          "type": "array",
          "items": {"type": "string"},
          "default": []
        }
      },
      "required": ["column", "functions"]
    },
    "SortParams": {
      "type": "object",
      "description": "Parameters for sort operations",
      "properties": {
        "columns": {
          "type": "array",
          "items": {"type": "string"},
          "minItems": 1
        },
        "descending": {
          "type": "array",
          "items": {"type": "boolean"},
          "description": "Per-column sort direction (true = descending, false = ascending)"
        }
      },
      "required": ["columns"]
    },
    "SelectParams": {
      "type": "object",
      "description": "Parameters for select/drop operations",
      "properties": {
        "columns": {
          "type": "array",
          "items": {"type": "string"},
          "minItems": 1
        }
      },
      "required": ["columns"]
    },
    "RenameParams": {
      "type": "object",
      "description": "Parameters for rename operations",
      "properties": {
        "mapping": {
          "type": "object",
          "additionalProperties": {"type": "string"},
          "description": "Map of old_column_name -> new_column_name"
        }
      },
      "required": ["mapping"]
    },
    "WithColumnsParams": {
      "type": "object",
      "description": "Parameters for calculated column operations",
      "properties": {
        "new_column": {"type": "string"},
        "expression": {
          "type": "string",
          "description": "Python expression for calculated column (e.g., 'price * quantity')"
        }
      },
      "required": ["new_column", "expression"]
    },
    "JoinParams": {
      "type": "object",
      "description": "Parameters for join operations",
      "properties": {
        "right_dataset": {"type": "string"},
        "left_on": {"type": "string"},
        "right_on": {"type": "string"},
        "how": {
          "type": "string",
          "enum": ["inner", "left", "right", "outer", "cross"]
        }
      },
      "required": ["right_dataset", "left_on", "right_on", "how"]
    },
    "PivotParams": {
      "type": "object",
      "description": "Parameters for pivot operations",
      "properties": {
        "row_dimensions": {
          "type": "array",
          "items": {"type": "string"}
        },
        "column_dimensions": {
          "type": "array",
          "items": {"type": "string"}
        },
        "values": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "column": {"type": "string"},
              "function": {
                "type": "string",
                "enum": ["count", "sum", "mean", "median", "min", "max"]
              }
            },
            "required": ["column", "function"]
          },
          "minItems": 1
        }
      },
      "required": ["values"]
    },
    "SampleParams": {
      "type": "object",
      "description": "Parameters for head/tail/sample operations",
      "properties": {
        "n": {
          "type": "integer",
          "minimum": 1,
          "description": "Number of rows"
        },
        "random": {
          "type": "boolean",
          "description": "For sample operation: whether to use random sampling"
        },
        "seed": {
          "type": "integer",
          "description": "Random seed for reproducible sampling"
        }
      },
      "required": ["n"]
    },
    "FillNullParams": {
      "type": "object",
      "description": "Parameters for fill_null operations",
      "properties": {
        "strategy": {
          "type": "string",
          "enum": ["forward", "backward", "mean", "median", "zero", "literal"],
          "description": "Fill strategy"
        },
        "value": {
          "description": "Literal value for strategy='literal'"
        }
      },
      "required": ["strategy"]
    }
  },
  "examples": [
    [
      {
        "code": "df.filter(nw.col('age') > 25)",
        "display": "Filter: age > 25",
        "operation_type": "filter",
        "params": {
          "column": "age",
          "operator": ">",
          "value": 25
        }
      },
      {
        "code": "df.group_by('department').agg([nw.col('salary').mean().alias('salary_mean')])",
        "display": "Aggregate: MEAN of salary grouped by department",
        "operation_type": "aggregate",
        "params": {
          "column": "salary",
          "functions": ["mean"],
          "group_by": ["department"]
        }
      },
      {
        "code": "df.sort('date', descending=True)",
        "display": "Sort: date (descending)",
        "operation_type": "sort",
        "params": {
          "columns": ["date"],
          "descending": [true]
        }
      }
    ]
  ]
}
